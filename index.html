<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/BillyPung/mind-ar-js/mindar-image-aframe.prod.js"></script>
    <script type="importmap">
        {
          "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.179.1/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.179.1/examples/jsm/",
            "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
          }
        }
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/css/style.css">
    <title>AR Demo</title>

    <!--
      target image's scene © MatiasMyma, licensed under CC BY 4.0. link: https://skfb.ly/6TsHR
      3D model "Berserk Armor" © Angy97, licensed under CC BY 4.0. link: https://skfb.ly/ow9J7
      dark soul's sign © FromSoftware, https://darksouls.fandom.com/wiki/Darksign_(Dark_Souls_III)?file=Darksign_%28DSIII%29.png
      sword emblem © deviantart, https://www.deviantart.com/captain-softspot/art/Dark-Souls-Emblem-1-827728764
      roar sound effect © Myinstants and uploaded by lucas4254, https://www.myinstants.com/en/instant/bonfire-dark-souls-86656/
      background music © Suno AI, generated by AI, https://suno.ai/
      This is a personal, non-commercial project.
    -->

</head>

<body>
<!-- Start UI Overlay -->
<div id="ui-overlay">
    <div class="start-container">
        <p>同意摄像头权限后，将摄像头对准识别图像。</p>
        <button id="start-button">开始</button>
        <div id="loading-indicator">
            <div class="spinner"></div>
            <p style="color: white; margin-top: 10px;">启动AR中</p>
        </div>
    </div>
</div>

<!-- AR Controls
<div id="controls">
    <button id="pause-button">Pause</button>
    <button id="stop-button">Stop</button>
</div>

&lt;!&ndash; Status Display &ndash;&gt;
<div id="status">Ready to scan</div>-->

<!-- A-Frame Scene -->
<a-scene mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/mind/armor-targets.mind;
            maxTrack: 1; filterMinCF: 0.0001; filterBeta: 0.01; warmupTolerance: 3; autoStart: false;"
         color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights"
         vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">

    <a-assets>
        <img id="circle" src="https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/imgs/Darksign_(DSIII).png"/>
        <img id="sword" src="https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/imgs/sword.png"/>
        <a-asset-item id="avatarModel" src="https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/models/scene.gltf"></a-asset-item>

        <!-- Sound Assets -->
        <audio id="background-music" src="https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/sounds/ShadowEmbrace.mp3" preload="auto"></audio>
        <audio id="roar-sound" src="https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/sounds/roar.mp3" preload="auto"></audio>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"
              cursor="fuse: false; rayOrigin: mouse;"
              raycaster="near: 10; far: 10000; objects: .clickable"></a-camera>

    <!-- Background Music Entity -->
    <a-entity id="background-music-entity"
              sound="src: #background-music; autoplay: false; loop: true; volume: 0.3; positional: false">
    </a-entity>

    <!-- Roar Sound Entity -->
    <a-entity id="roar-sound-entity"
              sound="src: #roar-sound; autoplay: false; loop: false; volume: 0.7; positional: false">
    </a-entity>

    <a-entity id="armor-target" mindar-image-target="targetIndex: 0">
        <a-image src="#circle" position="0 -0.185 0.6" rotation="90 0 0" height="0.8" width="0.8" rotation="0 0 0"
                 id="dark-sign"></a-image>
        <a-image src="#sword" position="0 0.4 0.1" rotation="0 0 0" height="1.1" width="1.1" rotation="0 0 0"
                 id="sword-image"></a-image>
        <a-gltf-model rotation="180 0 180" position="0 -0.2 0.6" scale="0.5 0.5 0.5" src="#avatarModel"
                      animation-mixer="clip: *; loop: repeat;"
                      animation="property: rotation; to: 180 360 180; dur: 20000; easing: linear; loop: true;"
                      class="clickable" id="armor-model">
        </a-gltf-model>
    </a-entity>
</a-scene>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Get references to DOM elements
        const sceneEl = document.querySelector('a-scene');
        const uiOverlay = document.getElementById('ui-overlay');
        const startButton = document.getElementById('start-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        /*const controls = document.getElementById('controls');*/
        //const status = document.getElementById('status');
        /*const pauseButton = document.getElementById('pause-button');
        const stopButton = document.getElementById('stop-button');*/

        // Target elements
        //const swordImage = document.getElementById('sword-image');
        const armorModel = document.getElementById('armor-model');

        // Sound entities
        const backgroundMusicEntity = document.getElementById('background-music-entity');
        const roarSoundEntity = document.getElementById('roar-sound-entity');

        let arSystem;
        let isARStarted = false;

        // Wait for scene to load
        sceneEl.addEventListener('loaded', function () {
            arSystem = sceneEl.systems["mindar-image-system"];
            console.log("Scene loaded, AR system ready");
        });

        // Preload assets function
        async function preloadAssets() {
            const assets = [
                'https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/imgs/Darksign_(DSIII).png',
                'https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/imgs/sword.png',
                'https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/models/scene.gltf',
                'https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/sounds/roar.mp3',
                'https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/sounds/ShadowEmbrace.mp3'
            ];

            const promises = assets.map(url => {
                return new Promise((resolve, reject) => {
                    if (url.endsWith('.gltf')) {
                        // For GLTF, we'll let A-Frame handle it
                        resolve();
                    } else if (url.endsWith('.mp3')) {
                        // For audio files, create Audio object to preload
                        const audio = new Audio();
                        audio.oncanplaythrough = resolve;
                        audio.onerror = reject;
                        audio.src = url;
                    } else {
                        const img = new Image();
                        img.onload = resolve;
                        img.onerror = reject;
                        img.src = url;
                    }
                });
            });

            try {
                await Promise.all(promises);
                console.log("Assets preloaded successfully");
            } catch (error) {
                console.warn("Some assets failed to preload:", error);
            }
        }

        // Start button click handler
        startButton.addEventListener('click', async () => {
            startButton.disabled = true;
            startButton.textContent = "加载中...";
            loadingIndicator.style.display = "block";

            try {
                // Preload assets
                await preloadAssets();

                // Start AR system
                if (arSystem) {
                    arSystem.start();
                    isARStarted = true;

                    // Play background music after successful AR start
                    // Add a small delay to ensure everything is properly initialized
                    setTimeout(() => {
                        if (backgroundMusicEntity && backgroundMusicEntity.components.sound) {
                            backgroundMusicEntity.components.sound.playSound();
                            console.log("Background music started");
                        }
                    }, 1000);
                } else {
                    throw new Error("AR系统准备中");
                }
            } catch (error) {
                console.error("Failed to start AR:", error);
                startButton.disabled = false;
                startButton.textContent = "Start AR Experience";
                loadingIndicator.style.display = "none";
                alert("AR系统启动失败，请检查网络连接或摄像头权限并刷新。");
            }
        });

        // AR Event Listeners
        sceneEl.addEventListener("arReady", (event) => {
            console.log("MindAR is ready");
            // Hide overlay and show controls
            uiOverlay.classList.add('hidden');
            /*controls.style.display = 'block';*/
            /*status.style.display = 'block';
            status.textContent = "AR Ready - Look for the target!";*/
        });

        sceneEl.addEventListener("arError", (event) => {
            console.error("MindAR failed to start", event);
            startButton.disabled = false;
            startButton.textContent = "Start AR Experience";
            loadingIndicator.style.display = "none";
            alert("AR failed to start. Please check camera permissions and try again.");
        });

        /*// Target tracking events
        armorTarget.addEventListener("targetFound", event => {
            console.log("Armor target found");
            status.textContent = "🎯 Target Found! Armor is now visible";
            status.style.background = "rgba(0, 150, 0, 0.8)";
        });

        armorTarget.addEventListener("targetLost", event => {
            console.log("Armor target lost");
            status.textContent = "🔍 Target Lost - Keep looking for the target";
            status.style.background = "rgba(150, 0, 0, 0.8)";
        });*/

        // Click interactions
        /*swordImage.addEventListener("click", event => {
            console.log("Sword clicked");
            swordImage.setAttribute('animation__click', {
                property: 'rotation',
                to: '0 0 360',
                dur: 1000,
                loop: 1
            });
        });*/

        armorModel.addEventListener("click", event => {
            console.log("Armor model clicked");

            // Play roar sound when model is clicked
            if (roarSoundEntity && roarSoundEntity.components.sound) {
                // Stop the sound first in case it's already playing
                roarSoundEntity.components.sound.stopSound();
                // Then play it
                roarSoundEntity.components.sound.playSound();
                console.log("Roar sound played");
            }
        });

        // Control buttons
        /*pauseButton.addEventListener('click', () => {
            if (arSystem && isARStarted) {
                arSystem.pause();
                pauseButton.textContent = "Resume";
                //status.textContent = "AR Paused";

                // Pause background music when AR is paused
                if (backgroundMusicEntity && backgroundMusicEntity.components.sound) {
                    backgroundMusicEntity.components.sound.pauseSound();
                }
            } else if (arSystem) {
                arSystem.unpause();
                pauseButton.textContent = "Pause";
                //status.textContent = "AR Resumed - Look for the target!";

                // Resume background music when AR is resumed
                if (backgroundMusicEntity && backgroundMusicEntity.components.sound) {
                    backgroundMusicEntity.components.sound.playSound();
                }
            }
        });

        stopButton.addEventListener('click', () => {
            if (arSystem && isARStarted) {
                arSystem.stop();
                isARStarted = false;

                // Stop background music when AR is stopped
                if (backgroundMusicEntity && backgroundMusicEntity.components.sound) {
                    backgroundMusicEntity.components.sound.stopSound();
                }

                // Reset UI
                uiOverlay.classList.remove('hidden');
                controls.style.display = 'none';
                status.style.display = 'none';
                startButton.disabled = false;
                startButton.textContent = "Start AR Experience";
                loadingIndicator.style.display = "none";
                pauseButton.textContent = "Pause";
            }
        });*/
    });
</script>
</body>
</html>
