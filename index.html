<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/BillyPung/mind-ar-js/mindar-image-aframe.prod.js"></script>
    <script type="importmap">
        {
          "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.179.1/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.179.1/examples/jsm/",
            "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
          }
        }
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/css/style.css">
    <title>AR Demo</title>
    <style>
        /* Additional styles for loading states */
        .model-loading-overlay {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 998;
            display: none;
        }

        .loading-progress {
            width: 150px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        /* Copy Link Button */
        #copy-link-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.3rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 200px;
        }

        #copy-link-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #45a049, #4CAF50);
        }
    </style>

    <!--
      target image's scene © MatiasMyma, licensed under CC BY 4.0. link: https://skfb.ly/6TsHR
      3D model "Berserk Armor" © Angy97, licensed under CC BY 4.0. link: https://skfb.ly/ow9J7
      dark soul's sign © FromSoftware, https://darksouls.fandom.com/wiki/Darksign_(Dark_Souls_III)?file=Darksign_%28DSIII%29.png
      sword emblem © deviantart, https://www.deviantart.com/captain-softspot/art/Dark-Souls-Emblem-1-827728764
      roar sound effect © Myinstants and uploaded by lucas4254, https://www.myinstants.com/en/instant/bonfire-dark-souls-86656/
      background music © Suno AI, generated by AI, https://suno.ai/
      This is a personal, non-commercial project.
    -->
</head>

<body>
<!-- Start UI Overlay -->
<div id="ui-overlay">
    <div class="start-container">
        <p id="main-instruction">同意摄像头权限后，将摄像头对准识别图像。</p>

        <!-- Safari Warning (initially hidden) -->
        <div id="safari-warning" style="display: none;">
            <h3 style="color: #ff6b6b; margin-bottom: 1rem;">⚠️ 浏览器不兼容</h3>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 1rem;">
                Safari浏览器对AR功能支持有限，请使用以下浏览器获得最佳体验：
            </p>
            <p style="color: white; font-weight: bold; margin-bottom: 1.5rem;">
                📱 Chrome | 🦊 Firefox | 🌐 Edge
            </p>
            <button id="copy-link-button">复制链接</button>
            <p id="copy-success" style="color: #4CAF50; margin-top: 10px; display: none;">
                ✅ 链接已复制！请在其他浏览器中打开
            </p>
        </div>

        <!-- Normal start interface -->
        <div id="normal-interface">
            <button id="start-button" disabled>系统准备中...</button>
            <div id="loading-indicator">
                <div class="spinner"></div>
                <p style="color: white; margin-top: 10px;">启动AR中</p>
            </div>
            <div id="model-preload-status" style="color: rgba(255,255,255,0.8); margin-top: 10px; display: none;">
                正在预加载3D模型...
                <div class="loading-progress">
                    <div class="loading-progress-bar" id="preload-progress"></div>
                </div>
            </div>
            <div id="error-message" style="color: #ff6b6b; margin-top: 10px; display: none;"></div>
        </div>
    </div>
</div>

<!-- Model Loading Status in AR -->
<div id="model-loading-overlay" class="model-loading-overlay">
    <div>模型加载中...</div>
    <div class="loading-progress">
        <div class="loading-progress-bar" id="ar-progress"></div>
    </div>
</div>

<!-- A-Frame Scene -->
<a-scene mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/mind/armor-targets.mind;
            maxTrack: 1; filterMinCF: 0.0001; filterBeta: 0.01; warmupTolerance: 3; autoStart: false;"
         color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights"
         vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">

    <a-assets>
        <img id="circle" src="https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/imgs/Darksign_(DSIII).png"/>
        <img id="sword" src="https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/imgs/sword.png"/>
        <a-asset-item id="avatarModel" src="https://cdn.jsdmirror.com/gh/BillyPung/MindARDemo/assets/models/scene.gltf"></a-asset-item>

        <!-- Sound Assets -->
        <audio id="background-music" src="https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/sounds/ShadowEmbrace.mp3" preload="none"></audio>
        <audio id="roar-sound" src="https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/sounds/roar.mp3" preload="none"></audio>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"
              cursor="fuse: false; rayOrigin: mouse;"
              raycaster="near: 10; far: 10000; objects: .clickable"></a-camera>

    <!-- Background Music Entity -->
    <a-entity id="background-music-entity"
              sound="src: #background-music; autoplay: false; loop: true; volume: 0.3; positional: false">
    </a-entity>

    <!-- Roar Sound Entity -->
    <a-entity id="roar-sound-entity"
              sound="src: #roar-sound; autoplay: false; loop: false; volume: 0.7; positional: false">
    </a-entity>

    <a-entity id="armor-target" mindar-image-target="targetIndex: 0">
        <a-image src="#circle" position="0 -0.185 0.6" rotation="90 0 0" height="0.8" width="0.8" rotation="0 0 0"
                 id="dark-sign"></a-image>
        <a-image src="#sword" position="0 0.4 0.1" rotation="0 0 0" height="1.1" width="1.1" rotation="0 0 0"
                 id="sword-image"></a-image>

        <!-- Placeholder while GLTF loads -->
        <a-box id="armor-placeholder"
               position="0 -0.2 0.6"
               scale="0.3 0.6 0.3"
               color="#444444"
               opacity="0.7"
               animation="property: rotation; to: 0 360 0; dur: 4000; easing: linear; loop: true"
               visible="true">
            <!-- Loading text above placeholder -->
            <a-text value="模型加载中..."
                    position="0 0.8 0"
                    align="center"
                    color="white"
                    scale="0.5 0.5 0.5"
                    animation="property: opacity; to: 0.3; dur: 1000; dir: alternate; loop: true">
            </a-text>
        </a-box>

        <!-- Actual GLTF Model (initially invisible) -->
        <a-gltf-model id="armor-model"
                      rotation="180 0 180"
                      position="0 -0.2 0.6"
                      scale="0.5 0.5 0.5"
                      src="#avatarModel"
                      animation-mixer="clip: *; loop: repeat;"
                      animation="property: rotation; to: 180 360 180; dur: 20000; easing: linear; loop: true;"
                      class="clickable"
                      visible="false">
        </a-gltf-model>
    </a-entity>
</a-scene>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Safari Detection
        function isSafariOrWeChatIOS() {
            const ua = navigator.userAgent.toLowerCase();
            const isSafari = ua.indexOf('safari') > -1 &&
                ua.indexOf('chrome') === -1 &&
                ua.indexOf('firefox') === -1;
            const isWeChatIOS = /micromessenger/.test(ua);
            return isSafari || isWeChatIOS;
        }

        // Get references to DOM elements
        const sceneEl = document.querySelector('a-scene');
        const uiOverlay = document.getElementById('ui-overlay');
        const startButton = document.getElementById('start-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const modelPreloadStatus = document.getElementById('model-preload-status');
        const preloadProgress = document.getElementById('preload-progress');
        const errorMessage = document.getElementById('error-message');
        const modelLoadingOverlay = document.getElementById('model-loading-overlay');
        const arProgress = document.getElementById('ar-progress');

        // Safari-related elements
        const safariWarning = document.getElementById('safari-warning');
        const normalInterface = document.getElementById('normal-interface');
        const copyLinkButton = document.getElementById('copy-link-button');
        const copySuccess = document.getElementById('copy-success');
        const mainInstruction = document.getElementById('main-instruction');

        // Check for Safari and show appropriate interface
        if (isSafariOrWeChatIOS()) {
            console.log("Safari detected - showing browser compatibility warning");
            safariWarning.style.display = 'block';
            normalInterface.style.display = 'none';
            mainInstruction.style.display = 'none';

            // Copy link button functionality
            copyLinkButton.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(window.location.href);
                    copySuccess.style.display = 'block';
                    copyLinkButton.textContent = '已复制！';

                    setTimeout(() => {
                        copySuccess.style.display = 'none';
                        copyLinkButton.textContent = '复制链接';
                    }, 3000);
                } catch (error) {
                    console.error('Failed to copy link:', error);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = window.location.href;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);

                    copySuccess.style.display = 'block';
                    copyLinkButton.textContent = '已复制！';

                    setTimeout(() => {
                        copySuccess.style.display = 'none';
                        copyLinkButton.textContent = '复制链接';
                    }, 3000);
                }
            });

            // Stop here - don't initialize AR for Safari users
            return;
        }

        // Target elements
        const armorModel = document.getElementById('armor-model');
        const armorPlaceholder = document.getElementById('armor-placeholder');
        const armorTarget = document.getElementById('armor-target');

        // Sound entities
        const backgroundMusicEntity = document.getElementById('background-music-entity');
        const roarSoundEntity = document.getElementById('roar-sound-entity');

        let arSystem;
        let isARStarted = false;
        let sceneLoaded = false;
        let modelLoaded = false;
        let targetVisible = false;

        // Helper function to show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            startButton.disabled = false;
            startButton.textContent = "重试";
            loadingIndicator.style.display = "none";
            modelPreloadStatus.style.display = "none";
        }

        // Update progress bar
        function updateProgress(progressBar, percent) {
            progressBar.style.width = percent + '%';
        }

        // GLTF Preloading with progress
        async function preloadGLTF() {
            return new Promise((resolve, reject) => {
                const loader = new THREE.GLTFLoader();

                // Show preload status
                modelPreloadStatus.style.display = 'block';
                updateProgress(preloadProgress, 0);

                loader.load(
                    'https://cdn.jsdmirror.com/gh/BillyPung/MindARDemo/assets/models/scene.gltf',

                    // onLoad
                    (gltf) => {
                        console.log('GLTF preloaded successfully');
                        updateProgress(preloadProgress, 100);
                        modelLoaded = true;
                        resolve(gltf);
                    },

                    // onProgress
                    (progress) => {
                        if (progress.lengthComputable) {
                            const percentComplete = (progress.loaded / progress.total) * 100;
                            updateProgress(preloadProgress, percentComplete);
                            console.log('GLTF loading progress:', percentComplete.toFixed(2) + '%');
                        } else {
                            // If we can't track progress, show animated progress
                            const fakeProgress = Math.min(90, Date.now() % 5000 / 5000 * 90);
                            updateProgress(preloadProgress, fakeProgress);
                        }
                    },

                    // onError
                    (error) => {
                        console.error('GLTF preload failed:', error);
                        reject(error);
                    }
                );
            });
        }

        // Enhanced preload assets function
        async function preloadAssets() {
            const imageAssets = [
                'https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/imgs/Darksign_(DSIII).png',
                'https://cdn.jsdelivr.net/gh/BillyPung/MindARDemo/assets/imgs/sword.png'
            ];

            try {
                // Load images first (quick)
                const imagePromises = imageAssets.map(url => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => resolve();
                        img.onerror = () => resolve(); // Don't fail for images
                        img.src = url;
                    });
                });

                await Promise.all(imagePromises);
                console.log("Images preloaded");

                // Then load GLTF (slow)
                await preloadGLTF();
                console.log("All assets preloaded successfully");

            } catch (error) {
                console.warn("GLTF preload failed:", error);
                throw error;
            }
        }

        // Wait for scene to load
        sceneEl.addEventListener('loaded', function () {
            console.log("Scene loading...");
            arSystem = sceneEl.systems["mindar-image-system"];
            sceneLoaded = true;

            // Enable start button only when scene is loaded
            startButton.disabled = false;
            startButton.textContent = "开始";
            console.log("Scene loaded, AR system ready");
        });

        // Model loaded event listener
        armorModel.addEventListener('model-loaded', () => {
            console.log('GLTF model loaded in A-Frame');

            // Hide placeholder and show model
            armorPlaceholder.setAttribute('visible', false);
            armorModel.setAttribute('visible', true);

            // Hide loading overlay if target is visible
            if (targetVisible) {
                modelLoadingOverlay.style.display = 'none';
            }
        });

        // Target tracking events
        armorTarget.addEventListener("targetFound", event => {
            console.log("Armor target found");
            targetVisible = true;

            // Play background music when target is found
            try {
                if (backgroundMusicEntity && backgroundMusicEntity.components.sound) {
                    backgroundMusicEntity.components.sound.playSound();
                    console.log("Background music started (target found)");
                }
            } catch (error) {
                console.log("Background music failed to start:", error);
            }

            // Show loading overlay if model isn't loaded yet
            if (!armorModel.getAttribute('visible')) {
                modelLoadingOverlay.style.display = 'block';

                // Animate progress bar while waiting for model
                let fakeProgress = 0;
                const progressInterval = setInterval(() => {
                    fakeProgress += 2;
                    updateProgress(arProgress, fakeProgress);

                    if (fakeProgress >= 100 || armorModel.getAttribute('visible')) {
                        clearInterval(progressInterval);
                        if (armorModel.getAttribute('visible')) {
                            modelLoadingOverlay.style.display = 'none';
                        }
                    }
                }, 100);
            }
        });

        armorTarget.addEventListener("targetLost", event => {
            console.log("Armor target lost");
            targetVisible = false;
            modelLoadingOverlay.style.display = 'none';

            // Pause background music when target is lost
            try {
                if (backgroundMusicEntity && backgroundMusicEntity.components.sound) {
                    backgroundMusicEntity.components.sound.pauseSound();
                    console.log("Background music paused (target lost)");
                }
            } catch (error) {
                console.log("Background music failed to pause:", error);
            }
        });

        // Start button click handler
        startButton.addEventListener('click', async () => {
            errorMessage.style.display = 'none';

            if (!sceneLoaded || !arSystem) {
                showError("场景还未加载完成，请稍等几秒后重试");
                return;
            }

            startButton.disabled = true;
            startButton.textContent = "加载中...";
            loadingIndicator.style.display = "block";

            try {
                console.log("Starting asset preload...");
                await preloadAssets();

                console.log("Starting AR system...");
                arSystem.start();
                isARStarted = true;

            } catch (error) {
                console.error("Failed to start AR:", error);

                if (error.message && error.message.includes('GLTF')) {
                    showError("3D模型加载失败，请检查网络连接");
                } else if (error.message && error.message.includes('camera')) {
                    showError("摄像头访问失败，请允许摄像头权限");
                } else {
                    showError(`启动失败: ${error.message || '未知错误'}`);
                }
            }
        });

        // AR Event Listeners
        sceneEl.addEventListener("arReady", (event) => {
            console.log("MindAR is ready");
            uiOverlay.classList.add('hidden');
        });

        sceneEl.addEventListener("arError", (event) => {
            console.error("MindAR failed to start", event);
            uiOverlay.classList.remove('hidden');

            if (event.detail && event.detail.error) {
                if (event.detail.error.name === 'NotAllowedError') {
                    showError("摄像头权限被拒绝，请允许摄像头访问");
                } else if (event.detail.error.name === 'NotFoundError') {
                    showError("未找到摄像头设备");
                } else {
                    showError(`AR错误: ${event.detail.error.message}`);
                }
            } else {
                showError("AR系统启动失败，请检查摄像头权限");
            }
        });

        // Click interaction for armor model
        armorModel.addEventListener("click", event => {
            console.log("Armor model clicked");

            try {
                if (roarSoundEntity && roarSoundEntity.components.sound) {
                    roarSoundEntity.components.sound.stopSound();
                    roarSoundEntity.components.sound.playSound();
                    console.log("Roar sound played");
                }
            } catch (error) {
                console.log("Failed to play roar sound:", error);
            }
        });

        // Scene loading timeout
        setTimeout(() => {
            if (!sceneLoaded) {
                console.warn("Scene loading timeout");
                showError("场景加载超时，请刷新页面重试");
            }
        }, 15000);
    });
</script>
</body>
</html>
